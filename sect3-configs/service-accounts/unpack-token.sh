#!/usr/bin/env bash
#  PURPOSE: Pull a token and dump to a locala file, then display the contents.
#           This script requires 1 argument = the pod name.
# -----------------------------------------------------------------------------
#     DOCS:
# -----------------------------------------------------------------------------
#  PREREQS: a)
#           b)
#           c)
# -----------------------------------------------------------------------------
#  EXECUTE:  ./unpack-token.sh my-fancy-pod
# -----------------------------------------------------------------------------
#     TODO: 1)
#           2)
#           3)
# -----------------------------------------------------------------------------
#   AUTHOR: Todd E Thomas (github.com/todd-dsm)
# -----------------------------------------------------------------------------
#set -x


###----------------------------------------------------------------------------
### VARIABLES
###----------------------------------------------------------------------------
# ENV Stuff
#: "${1?  Wheres my first agument, bro!}"
myPod="$1"
localFile='/tmp/token.json'
# Data


###----------------------------------------------------------------------------
### FUNCTIONS
###----------------------------------------------------------------------------
function pMsg() {
    theMessage="$1"
    printf '%s\n' "$theMessage"
}


###----------------------------------------------------------------------------
### MAIN PROGRAM
###----------------------------------------------------------------------------
### To view the token contents:
###---
pMsg "Pulling the token..."
kubectl exec -it "$myPod" -- \
    cat /var/run/secrets/kubernetes.io/serviceaccount/token > "$localFile"


###---
### REQ
###---
pMsg "Token contents:"
jq -R 'split(".") | select(length > 0) | .[0],.[1] |  @base64d | fromjson' \
    < "$localFile"


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### REQ
###---


###---
### fin~
###---
exit 0
